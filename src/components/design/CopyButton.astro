---
import type { LanguagesValue } from '../../model/languages.ts';

import CardButton from './CardButton.astro';

import { useUiTranslation } from '../../util/use-ui-translation';
import Toast from './Toast.astro';

interface Props {
  lang?: LanguagesValue;
}

const { lang = Astro.locals.lang } = Astro.props;

// we need a unique id for the toast, as there might be multiple on the page
const toastId = `toast-copy-${crypto.randomUUID()}`;
---

<template
  open
  id="copy-content"
  data-toastid={toastId}
>
  <slot />
</template>

<CardButton id="copy-button">
  {useUiTranslation('meta.copy', lang)}
</CardButton>

<Toast id={toastId}>
  {useUiTranslation('meta.copiedContentToClipboard', lang)}</Toast
>
<script>
  const copyContent: HTMLTemplateElement =
    document.querySelector('#copy-content')!;
  const copyButton: HTMLButtonElement = document.querySelector('#copy-button')!;
  const copyPopover: HTMLElement = document.querySelector(
    `#${copyContent.dataset.toastid}`,
  )!;

  copyButton?.addEventListener('click', async () => {
    const html = new Blob([copyContent.innerHTML], { type: 'text/html' });
    const text = new Blob([copyContent.content.textContent ?? ''], {
      type: 'text/plain',
    });
    const data = new ClipboardItem({ 'text/html': html, 'text/plain': text });
    await navigator.clipboard.write([data]);
    copyPopover.showPopover();
  });
</script>
