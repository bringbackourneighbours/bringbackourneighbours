---
import type { LanguagesValue } from '../../model/languages.ts';

import CardButton from './CardButton.astro';
import Toast from './Toast.astro';

import { useUiTranslation } from '../../content/use-ui-translation.ts';

interface Props {
  lang?: LanguagesValue;
  title?: string;
  text?: string;
  url: string;
}

const { lang = Astro.locals.lang, url = Astro.site } = Astro.props;

const title = Astro.props.title || (await useUiTranslation('meta.title', lang));
const text =
  Astro.props.text ||
  (await useUiTranslation('meta.infosAgainstDeportation', lang));

// we need a unique id for the toast, as there might be multiple on the page
const toastId = `toast-share-${crypto.randomUUID()}`;
---

<CardButton id="share-button">
  {useUiTranslation('meta.share', lang)}
</CardButton>

<Toast id={toastId}>
  {useUiTranslation('meta.sharedLinkToClipboard', lang)}
</Toast>

<template
  open
  id="share-meta"
  data-toastid={toastId}
  data-title={title}
  data-text={text}
  data-url={url}
></template>

<script>
  const shareMeta: HTMLTemplateElement = document.querySelector('#share-meta')!;
  const shareButton: HTMLElement = document.querySelector('#share-button')!;
  const shareToast: HTMLElement = document.querySelector(
    `#${shareMeta.dataset.toastid}`,
  )!;

  shareButton?.addEventListener('click', async () => {
    if (navigator.share && shareMeta?.dataset?.url) {
      navigator
        .share({
          title: shareMeta.dataset.title,
          text: shareMeta.dataset.text,
          url: shareMeta.dataset.url,
        })
        .then(() => {})
        .catch(console.error);
    } else {
      await navigator.clipboard.writeText(
        `${shareMeta.dataset.text}:\n ${shareMeta.dataset.title} \n ${shareMeta.dataset.url} `,
      );
      shareToast.showPopover();
    }
  });
</script>
